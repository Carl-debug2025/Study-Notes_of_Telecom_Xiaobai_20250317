# 51单片机第一周笔记

## 新建工程<!-- 测试一下注释功能 -->

1. 新建一个文件夹，起好名字，打开keil
2. 点击新建项目，找到刚才建好的文件夹，命名工程。**(一般和文件夹同名)**
3. 选择蓝桥杯单片机芯片搜索`89c52`
4. 点击魔法棒->勾选`hex`文件**(只有勾选hex文件才能烧录)**->点击品字形图标->Project Targets为工程名，Group为user。此时若工程生成成功，刚开始的文件夹应该有3个文件
5. 右键user添加c语言文件main

***养成良好的编程习惯，每一个不同的工程项目对应一个不同的文件夹***

---

## 主体框架

```c
/* 头文件区域 */
#include <REGX52.H>

/* Main */
void main()
{
    while(1)
    {
        
    }
}
```

---

## LED灯：梦开始的地方

### **1.点亮LED灯**

- 对P1整体进行赋值，控制所有的LED灯

```c
P1 = 0xAA; //7灯到1灯(从左到右)依次灭亮
```

- 对P1中八个IO口单独赋值，控制单个LED灯

```c
P1_0 = 0; //点亮第一个灯
P1_7 = 0; //点亮最后一个灯
```

### 2.**LED灯闪烁**

*原理：通过不断给IO口赋值高低电平实现闪烁，但单品机执行循环非常快，肉眼看不出闪烁，得用到延时函数*

- **得到固定延时函数**

1. 打开ISP软件，找到软件延时计时器，晶振选择12HZ
2. 定时长度100ms(按自己需求来)
3. 8051指令集`STC_Y1`(Y1适用89cxx)
4. 生成c代码
5. 生成的代码放到main函数上面否则会报错

- **函数调用实现闪烁**

```c
P1_0 = 0;
Delay100ms();
P1_0 = 1;
Delay100ms();
```

- **修改一毫秒延时函数，使其可以任意选择延时时间**

```c
void Delay(unsigned char xms)
{
    unsigned char i, j;
    while(xms--)
    {
        i = a; //这里a从ISP中得到
        j = b; //这里b从ISP中得到
        do
        {
            while (--j);
            while (--i);
        }
	}
}
```

*注意要删除生成的nop语句*

### **3.流水灯(通过内置库函数实现)**

```c
#include <intrins.h>

/* 变量声明区 */
unsigned char ucLed = 0xfe; /// 1111 1110 默认第一个灯点亮
void main()
{
    while(1)
    {
        ucLed = _crol_(ucLed, 1); // 循环左移，循环右移为_cror_
        P1 = ucLed;
        Delay(100);
    }
}
```

- **扩展：变速流水灯**

```c
/* 变量声明区 */
unsigned char ucLed = 0xfe; // 1111 1110 默认第一个灯点亮
unsigned int time = 1000; // unsigned char 范围是0~255，这里用int(0~65535)
void main()
{
    while(1)
    {
        ucLed = _crol_(ucLed, 1);
        P1 = ucLed;
        Delay(time);
        time = time - 100;
    }
}
```

---

## 按键

### **按键读取函数**

```c
/*按键读取函数*/
unsigned char Key_Read()
{
    unsigned char temp = 0; //一定要先赋初值
    if(P3_4 == 0) temp = 1;
    if(P3_5 == 0) temp = 2;
    if(P3_6 == 0) temp = 3;
    if(P3_7 == 0) temp = 4;
    return temp;
}
```

***引脚根据每个开发板的不同自行修改***

### **先死记四行代码**

```c
unsigned char Key_Val, Key_Down, Key_Up, Key_Old;
void main()
{
    while(1)
    {
        Key_Val = Key_Read();
        Key_Down = Key_Val & (Key_Val ^ Key_Old);//检测下降沿
        Key_Up = ~Key_Val & (Key_Val ^ Key_Old);//检测上升沿
        Key_Old = Key_Val;//扫描辅助变量
    }
}
```

***Key_Down标记按键是否按下，Key_Up标记按键是否抬起，Key_Old标记按键是否在一直按着***

### **按键控制LED亮灭状态**

```c
unsigned char Key_Val, Key_Down, Key_Up, Key_Old;
void main()
{
    while(1)
    {
        Key_Val = Key_Read();
        Key_Down = Key_Val & (Key_Val ^ Key_Old);//检测下降沿
        Key_Up = ~Key_Val & (Key_Val ^ Key_Old);//检测上升沿
        Key_Old = Key_Val;//扫描辅助变量
        if(Key_Down == 1)
            P1_0 = 0;
        if(Key_Up == 2)
            P1_0 = 1;
        if(Key_Old == 3)
            P1_1 = 0;
        else
            P1_1 = 1;
    }
}
```

### **按键控制LED流水灯状态**

```c
/* 变量声明区 */
unsigned char ucLed = 0xfe;
unsigned char Key_Val, Key_Down, Key_Up, Key_Old;
bit System_Flag;//标志位

/*按键读取函数*/
unsigned char Key_Read()
{
    unsigned char temp = 0; //一定要先赋初值
    if(P3_4 == 0) temp = 1;
    if(P3_5 == 0) temp = 2;
    if(P3_6 == 0) temp = 3;
    if(P3_7 == 0) temp = 4;
    return temp;
}

void main()
{
    while(1)
    {
        Key_Val = Key_Read();
        Key_Down = Key_Val & (Key_Val ^ Key_Old);//检测下降沿
        Key_Up = ~Key_Val & (Key_Val ^ Key_Old);//检测上升沿
        Key_Old = Key_Val;//扫描辅助变量
        
        if(System_Flag == 1)
        {
            ucLed = _crol_(ucLed, 1);
            P1 = ucLed;
            Delay(100);
        }
       
        /*if(Key_Down == 1)
            System_Flag = 1;
        if(Key_Down == 2)
            System_Flag = 0;*/
        switch (Key_Down)
        {
            case 1:
            	System_Flag = 1;
            break;
            case 2:
            	System_Flag = 0;
            break;    
        }
    }
}
```

### **矩阵按键控制LED亮灭**

```c
/*矩阵按键读取函数*/
unsigned char Key_Read()
{
    unsigned char temp = 0; //一定要先赋初值
    P3_0 = 0; P3_1 = 1; P3_2 = 1; P3_3 = 1;
    if(P3_4 == 0) temp = 1;
    if(P3_5 == 0) temp = 2;
    if(P3_6 == 0) temp = 3;
    if(P3_7 == 0) temp = 4;
    P3_0 = 1; P3_1 = 0; P3_2 = 1; P3_3 = 1;
    if(P3_4 == 0) temp = 5;
    if(P3_5 == 0) temp = 6;
    if(P3_6 == 0) temp = 7;
    if(P3_7 == 0) temp = 8; 
    P3_0 = 1; P3_1 = 1; P3_2 = 0; P3_3 = 1;
    if(P3_4 == 0) temp = 9;
    if(P3_5 == 0) temp = 10;
    if(P3_6 == 0) temp = 11;
    if(P3_7 == 0) temp = 12;  
    P3_0 = 1; P3_1 = 1; P3_2 = 1; P3_3 = 0;
    if(P3_4 == 0) temp = 13;
    if(P3_5 == 0) temp = 14;
    if(P3_6 == 0) temp = 15;
    if(P3_7 == 0) temp = 16;
    return temp;
}
```

***本质：先选择行，再选择列***

### **矩阵按键控制LED流水灯状态**

```c
/* 变量声明区 */
unsigned char ucLed = 0xfe;
unsigned char Key_Val, Key_Down, Key_Up, Key_Old;
bit System_Flag;//标志位
unsigned char int Time = 500;

void main()
{
    while(1)
    {
        Key_Val = Key_Read();
        Key_Down = Key_Val & (Key_Val ^ Key_Old);//检测下降沿
        Key_Up = ~Key_Val & (Key_Val ^ Key_Old);//检测上升沿
        Key_Old = Key_Val;//扫描辅助变量
        
        if(System_Flag == 1)
        {
            ucLed = _crol_(ucLed, 1);
            P1 = ucLed;
            Delay(Time);
        }
       
        /*if(Key_Down == 1)
            System_Flag = 1;
        if(Key_Down == 2)
            System_Flag = 0;*/
        switch (Key_Down)
        {
            case 1:
            	System_Flag = 1;
            break;
            case 2:
            	System_Flag = 0;
            break;    
            case 3:
            	Time += 100;
            break;
            case 4:
                Time -= 100;
            break;
        }
    }
}
```

### **彩灯控制系统**

- **数组和数组指针、标志位控制彩灯流转**

```c
unsigned char Key_Val, Key_Down, Key_Up, Key_Old;
unsigned char Led_Data = 0xfe;
unsigned char Led_34_Data[4] = {0x7e, 0xbd, 0xdb, 0xe7};
unsigned char Led_34_Data_Index = 0;
unsigned char Mode = 0;
bit Led_Flag = 1;//启动标志位 1彩灯系统启动 0彩灯系统暂停 题目要求上电时，默认模式1启动状态
```

- 按键控制模式

```c
switch (Key_Down)
{
    case  1:
        Led_Flag = 1;
        break;
    case  2:
        Led_Flag = 0;
    break;
    case  3:
        Mode++;
        if(Mode == 4) Mode = 0;
    break;
    case  4:
        Mode--;
        if(Mode == 255) Mode = 3;
    break;
}
```

- 模式控制彩灯流转

```c
if(Led_Flag == 1)//处于启动状态
{
    switch (Mode)
    {
        case  0:
            P1 = Led_Data;
            Delay(500);
            Led_Data = _crol_(Led_Data, 1);
        break;
        case  1:
            P1 = Led_Data;
            Delay(500);
            Led_Data = _cror_(Led_Data, 1);
        break;
        case  2:
            P1 = Led_34_Data[Led_34_Data_Index];
            Delay(500);
            Led_34_Data_Index++;
            if(Led_34_Data_Index == 4) Led_34_Data_Index = 0;
        break;
        case  3:
            P1 = Led_34_Data[Led_34_Data_Index];
            Delay(500);
            Led_34_Data_Index--;
            if(Led_34_Data_Index == 255) Led_34_Data_Index = 3;
        break;
    }
}
```



















