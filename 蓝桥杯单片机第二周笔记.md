# 蓝桥杯大模板

## 关闭外设

```c
#include <Init.h>

void System_Init()
{
    P0 = 0xff;//关闭所有led灯
    P2 = P2 & 0x1f | 0x80;//Y4控制LED锁存器,使用38译码器使能，先屏蔽低五位，再打开前三位
    P2 &= 0X1f;//用完关上,将P2高3位清零，译码器停止输出（避免误操作其他外设）
    
    P0 = 0x00;//关闭蜂鸣器
    P2 = P2 & 0x1f | 0xa0;//Y5控制蜂鸣器锁存器,使用38译码器使能，先屏蔽低五位，再打开前三位
    P2 &= 0X1f;//确保译码器不再选中任何外设
}
```

```c
#include <STC15F2K60S2.H>
void System_Init();
```

---

## Led底层

```c
#include <Led.h>

void Led_Disp(unsigned char addr,enable)//例子：Led_Disp(1,1)第二个灯亮
{
    static unsigned char temp = 0x00;//存储当前LED的状态（1表示亮，0表示灭），初始全灭。
    static unsigned char temp_old = 0xff;// 上一次LED状态（默认全亮）
    
    if(enable)
        temp |= (0x01 << addr);
    else
        temp &= ~(0x01 << addr);
    if(temp != temp_old)
    {
        P0 = ~temp;
        P2 = P2 & 0x1f | 0x80;
        P2 &= 0x1f;
        temp_old = temp;
    }
}
```

```c
#include <STC15F2K60S2.H>
void Led_Disp(unsigned char addr,enable);
```

- ### **函数功能**

  - **作用**：控制指定编号的LED灯亮或灭。

  - 

    参数：

    - `addr`：LED的编号（0~7，对应8个LED）。
    - `enable`：控制标志（`1`亮，`0`灭）。

  - **示例**：`Led_Disp(1, 1)` 表示点亮第2个LED（编号从0开始）。

1. **静态变量初始化**

   ```c
   static unsigned char temp = 0x00;      // 当前LED状态（默认全灭）
   static unsigned char temp_old = 0xff;  // 上一次LED状态（默认全亮）
   ```

   - `temp`：存储当前LED的状态（`1`表示亮，`0`表示灭），初始全灭。
   - `temp_old`：存储上一次的状态，用于比较是否需要更新硬件。

2. **更新LED状态**

   ```c
   if(enable)
       temp |= (0x01 << addr);  // 将指定位置1（点亮）
   else
       temp &= ~(0x01 << addr); // 将指定位置0（熄灭）
   ```

   - **点亮操作**：`temp |= (0x01 << addr)`
     例如，`addr=1`时，`0x01 << 1` = `0x02`（二进制`00000010`），与`temp`按位或，确保第2位为1。
   - **熄灭操作**：`temp &= ~(0x01 << addr)`
     同上，取反后按位与，确保第2位为0。

3. **状态变化检测与硬件更新**

   ```c
   if(temp != temp_old) {
       P0 = ~temp;              // 取反后输出到P0（共阳极接法）
       P2 = P2 & 0x1f | 0x80;   // 选中Y4（锁存LED状态）
       P2 &= 0x1f;              // 关闭译码器
       temp_old = temp;         // 更新旧状态
   }
   ```

   - **优化更新**：仅当`temp`变化时才操作硬件（避免频繁IO操作）。

   - **P0输出**：`~temp`
     由于LED是共阳极接法（`0`点亮，`1`熄灭），需要对`temp`取反。

     译码器控制：

     - `P2 & 0x1f | 0x80`：保留P2低5位，高3位设为`100`（选中Y4）。
     - `P2 &= 0x1f`：操作完成后关闭译码器（防止干扰其他外设）。

### **关键硬件设计**

1. **LED连接方式**：
   - **共阳极**：所有LED正极接VCC，P0输出`0`点亮，`1`熄灭。
   - **8位LED**：P0的8个引脚（P0.0~P0.7）分别控制8个LED。
2. **3-8译码器（如74HC138）**：
   - 通过P2的高3位（P2.7、P2.6、P2.5）选择外设，`Y4`（对应`100`）用于锁存LED状态。
3. **锁存器（如74HC573）**：
   - 通过Y4使能锁存器，将P0的状态锁定到LED模块，避免持续占用P0端口。

---

## Main

```c
/*头文件声明区*/
#include <Init.h>
#include <Led.h>

void main()
{
	System_Init();
	while(1)
    {
        Led_Disp(0, 1);
    }
}
```

